# yaml-language-server: $schema=https://raw.githubusercontent.com/onyx-hq/onyx-public-releases/refs/heads/main/json-schemas/workflow.json

name: cache_sample
steps:
  - name: property_grouping
    type: execute_sql
    warehouse: local
    sql_file: data/example_property_grouping.sql

  - name: groupings
    type: loop_sequential
    values: "{{ property_grouping.property_grouping }}"
    steps:
      - name: sql
        type: agent
        prompt: |
          Generate a SQL to support {{groupings.value}} report generation.
        agent_ref: agents/sql.agent.yml
        cache:
          enabled: true
          path: output/cache/groupings_{{groupings.value}}_query.sql
      - name: execute_sql
        type: execute_sql
        warehouse: local
        sql_query: "{{sql}}"
      - name: report
        type: agent
        agent_ref: agents/local.agent.yml
        prompt: |
          Generate a report for {{groupings.value}}.
          Using following data:
          [BEGIN DATA]
          {{execute_sql}}
          [END DATA]
        cache:
          enabled: true
          path: output/cache/groupings_{{groupings.value}}_report.json

  - name: grouping_reports
    type: formatter
    template: |
      {% for grouping in groupings %}
      -- Property Grouping: {{ grouping.value }} --
      {{ grouping.report }}
      -- End of Property Grouping: {{ grouping.value }} --
      {% endfor %}
