name: insights
description: |
  Name: Oxymart Retail Analytics Dashboard

  This data app generates essential retail analysis insights using Oxymart sales data.
  It focuses on the most important retail metrics to provide a streamlined dashboard
  experience while minimizing loading time. The dashboard includes various chart types
  (line, bar, pie) to better visualize different aspects of the retail data.

tasks:
  - name: top_stores
    type: execute_sql
    sql_query: |
      SELECT 
        Store,
        SUM(Weekly_Sales) AS Total_Sales,
        AVG(Weekly_Sales) AS Avg_Weekly_Sales
      FROM 'oxymart.csv'
      GROUP BY Store
      ORDER BY Total_Sales DESC
      LIMIT 5
    database: local

  - name: temperature_effect
    type: execute_sql
    sql_query: |
      SELECT 
        CASE 
          WHEN Temperature < 40 THEN 'Cold (< 40°F)'
          WHEN Temperature BETWEEN 40 AND 70 THEN 'Moderate (40-70°F)'
          ELSE 'Hot (> 70°F)'
        END AS temp_range,
        AVG(Weekly_Sales) AS avg_sales
      FROM 'oxymart.csv'
      GROUP BY temp_range
      ORDER BY 
        CASE temp_range
          WHEN 'Cold (< 40°F)' THEN 1
          WHEN 'Moderate (40-70°F)' THEN 2
          ELSE 3
        END
    database: local

  - name: holiday_impact
    type: execute_sql
    sql_query: |
      SELECT 
        CASE WHEN Holiday_Flag = 1 THEN 'Holiday' ELSE 'Non-Holiday' END AS period,
        AVG(Weekly_Sales) AS avg_sales,
        COUNT(*) AS week_count
      FROM 'oxymart.csv'
      GROUP BY Holiday_Flag
      ORDER BY Holiday_Flag DESC
    database: local

  # New query for sales trend over time (for line chart)
  - name: sales_trend
    type: execute_sql
    sql_query: |
      SELECT 
        strftime(Date, '%Y-%m') AS month,
        AVG(Weekly_Sales) AS avg_sales
      FROM 'oxymart.csv'
      GROUP BY month
      ORDER BY month
    database: local

  # New query for economic factors correlation (for line chart with series)
  - name: economic_trends
    type: execute_sql
    sql_query: |
      SELECT 
        strftime(Date, '%Y-%m') AS month,
        'Fuel Price' AS indicator,
        AVG(Fuel_Price) AS value
      FROM 'oxymart.csv'
      GROUP BY month
      
      UNION ALL
      
      SELECT 
        strftime(Date, '%Y-%m') AS month,
        'Unemployment' AS indicator,
        AVG(Unemployment) AS value
      FROM 'oxymart.csv'
      GROUP BY month
      
      ORDER BY month, indicator
    database: local

  # Updated query with higher thresholds for store performance distribution
  - name: store_performance_distribution
    type: execute_sql
    sql_query: |
      SELECT 
        CASE 
          WHEN avg_sales >= 1500000 THEN 'High-performing (>$1500K)'
          WHEN avg_sales >= 1000000 THEN 'Medium-performing ($1000K-$1500K)'
          ELSE 'Low-performing (<$1000K)'
        END AS performance_category,
        COUNT(*) AS store_count
      FROM (
        SELECT 
          Store, 
          AVG(Weekly_Sales) AS avg_sales
        FROM 'oxymart.csv'
        GROUP BY Store
      )
      GROUP BY performance_category
      ORDER BY 
        CASE performance_category
          WHEN 'High-performing (>$1500K)' THEN 1
          WHEN 'Medium-performing ($1000K-$1500K)' THEN 2
          ELSE 3
        END
    database: local

display:
  - type: markdown
    content: |
      # Oxymart Retail Analytics Dashboard

      This dashboard provides essential analysis of Oxymart store performance and the impact of 
      various factors on retail sales. Below you'll find key insights about top-performing stores,
      temperature impact, and holiday effects visualized through various chart types.

  - type: bar_chart
    title: Top 5 Stores by Total Sales
    data: top_stores
    x: Store
    y: Total_Sales

  - type: pie_chart
    title: Store Performance Distribution
    data: store_performance_distribution
    name: performance_category
    value: store_count

  - type: bar_chart
    title: Temperature Impact on Average Sales
    data: temperature_effect
    x: temp_range
    y: avg_sales

  - type: pie_chart
    title: Holiday vs Non-Holiday Sales
    data: holiday_impact
    name: period
    value: avg_sales

  - type: line_chart
    title: Sales Trend Over Time
    data: sales_trend
    x: month
    y: avg_sales
    x_axis_label: Month
    y_axis_label: Average Weekly Sales ($)

  - type: line_chart
    title: Economic Indicators Over Time
    data: economic_trends
    x: month
    y: value
    series: indicator
    x_axis_label: Month
    y_axis_label: Value

  - type: table
    title: Economic Trends Data
    data: economic_trends

  - type: markdown
    content: |
      ## Retail Performance Analysis

      The dashboard highlights several key aspects of Oxymart's retail performance:

      1. **Top Performing Stores**: The bar chart shows the five stores with the highest total sales, providing insight into which locations are most successful.

      2. **Store Performance Distribution**: The pie chart categorizes stores by their average weekly sales performance using revised thresholds that better reflect the actual distribution of store performance across the network.

      3. **Temperature Impact**: This visualization demonstrates how different temperature ranges affect sales, revealing patterns that can inform seasonal strategy adjustments.

      4. **Holiday Effect**: The pie chart shows the relative sales performance during holiday and non-holiday periods, revealing the significant impact seasonal events have on consumer spending.

      5. **Sales Trends**: The line chart tracks sales performance over time, helping identify seasonal patterns and long-term trends.

      6. **Economic Indicators**: This line chart shows how fuel prices and unemployment rates change over time, allowing analysts to compare these trends with sales patterns.

      These insights can help with strategic planning around seasonal inventory management, store-specific promotions, and holiday marketing campaigns.