name: survey_responses
steps:
  - name: schedules
    type: loop_sequential
    values:
      - "weekly"
      - "monthly"
    steps:
      - name: metrics
        type: loop_sequential
        values:
          - "responses"
          - "rejected"
        steps:
          - name: table
            type: execute_sql
            warehouse: primary_warehouse
            sql_file: example_{{schedules.value}}_{{metrics.value}}.sql
            variables: 
              variable_a: "1000"
              variable_b: hello
              variable_c: "{{ metrics.value }}"
          - name: report
            type: agent
            prompt: |
              Generate a detail {{schedules.value}} report using {{metrics.value}} metrics:
              {{table}}
            agent_ref: local

      - name: metric_reports
        type: formatter
        template: |
          {% for metric in metrics %}
          -- Metric: {{metric.value}} --
          {{metric.report}}
          -- End of Metric: {{metric.value}} --
          {% endfor %}


  - name: formatter
    type: formatter
    template: |
      # Survey Responses Report
      {% for schedule in schedules %}
      -- Schedule: {{schedule.value}} --
      {{schedule.metric_reports}}
      -- End of Schedule: {{schedule.value}} --
      {% endfor %}
