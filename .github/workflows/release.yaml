name: Release
on:
  workflow_dispatch:
  push:
    tags:
      - "[0-9]+.[0-9]+.[0-9]+"
    paths-ignore:
      - 'docs/**'
env:
  CARGO_TERM_COLOR: always

jobs:
  changesets:
    uses: ./.github/workflows/changesets.yaml
  compile:
    concurrency:
      group: onyx-compile-${{ github.ref_name }}-${{ matrix.job.os }}-${{ matrix.job.target }}
      cancel-in-progress: true
    name: Releasing binary version ${{ github.ref_name }} for target ${{ matrix.job.target }}
    needs: [changesets]
    if: needs.changesets.outputs.onyx == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
    runs-on: ${{ matrix.job.os }}
    strategy:
      fail-fast: false
      matrix:
        job:
          - os: macos-latest
            target: x86_64-apple-darwin
            cross-compilation: false
          - os: macos-latest
            target: aarch64-apple-darwin
            cross-compilation: false
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            cross-compilation: false
          # - os: windows-latest
          #   target: x86_64-pc-windows-msvc
          #   cross-compilation: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Prep Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          rustflags: "" # temporarily override "-D warnings"
          target: ${{ matrix.job.target }}
          cache-key: release-${{ matrix.job.os }}-${{ matrix.job.target }}
      - name: Update Rust Toolchain Target
        run: |
          echo "targets = ['${{matrix.job.target}}']" >> rust-toolchain.toml
      - name: Install cross
        if: matrix.job.cross-compilation
        uses: taiki-e/install-action@v2
        with:
          tool: cross
      - name: Install Node.js
        uses: actions/setup-node@v4
        id: setup-node
        with:
          node-version: 20
      - uses: pnpm/action-setup@v4
        with:
          run_install: true

      - name: Get pnpm store directory
        if: matrix.job.os != 'windows-latest'
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      - name: Get pnpm store directory on Windows
        if: matrix.job.os == 'windows-latest'
        shell: pwsh
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - uses: actions/cache@v4
        name: Setup pnpm cache
        with:
          path: ${{ env.STORE_PATH }}
          key: pnpm-store-${{ matrix.job.os }}-${{ matrix.job.target }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ matrix.job.os }}-${{ matrix.job.target }}
            pnpm-store-${{ matrix.job.os }}-
      - name: Cache turbo build setup
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ matrix.job.os }}-${{ matrix.job.target }}-${{ github.sha }}
          restore-keys: |
            turbo-${{ matrix.job.os }}-${{ matrix.job.target }}-
            turbo-${{ matrix.job.os }}-
      - name: Build
        run: |
          pnpm -C web-app build
      # protobuf is required by lance https://github.com/lancedb/lance/issues/3073
      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Fix windows not resolving symlink
        if: matrix.job.os == 'windows-latest'
        run: |
          Remove-Item -Recurse -Force dist
          Copy-Item -Recurse web-app/dist dist

      - name: Cargo build
        if: matrix.job.os != 'windows-latest'
        shell: bash
        run: |
          if [[ "${{ matrix.job.cross-compilation }}" == "true" ]]; then
            cross build --release --target ${{ matrix.job.target }}
          else
            cargo build --release --target ${{ matrix.job.target }}
          fi
          cargo run --release --target ${{ matrix.job.target }} -- gen-config-schema
          mv target/${{ matrix.job.target }}/release/onyx onyx-${{ matrix.job.target }}
      - name: Cargo build on Windows
        if: matrix.job.os == 'windows-latest'
        shell: pwsh
        run: |
          cargo build --release --target ${{ matrix.job.target }}
          cargo run --release --target ${{ matrix.job.target }} -- gen-config-schema
          Move-Item -Path "target\${{ matrix.job.target }}\release\onyx.exe" -Destination "onyx-${{ matrix.job.target }}.exe"

      - name: Generate release tag
        id: tag
        run: |
          echo "release_tag=${{ github.ref_name }}" >> $GITHUB_ENV
      - name: Private github release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          tag_name: ${{ steps.tag.outputs.release_tag }}
          files: |
            onyx-${{ matrix.job.target }}*
            json-schemas/*
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
  release_publicly:
    runs-on: ubuntu-latest
    needs: [compile]
    steps:
    - uses: actions/create-github-app-token@v1
      name: Create GitHub App Token
      id: app-token
      with:
        app-id: ${{ vars.ARGO_APP_ID }}
        private-key: ${{ secrets.ARGO_APP_PRIVATE_KEY }}
        owner: ${{ github.repository_owner }}
        repositories: |
          onyx-public-releases
          onyx
    - name: Checkout Public Release repo
      uses: actions/checkout@v4
      with:
        repository: onyx-hq/onyx-public-releases
        token: ${{ steps.app-token.outputs.token }}
    - name: Download release assets from GitHub
      uses: robinraju/release-downloader@v1
      with:
        preRelease: false
        tag: ${{ github.ref_name }}
        zipBall: false
        token: ${{ steps.app-token.outputs.token }}
        fileName: "*"
        extract: false
    - name: Get GitHub App User ID
      id: get-user-id
      run: echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
      env:
        GH_TOKEN: ${{ steps.app-token.outputs.token }}
    - name: Tag the release
      run: |
        git config --global user.name '${{ steps.app-token.outputs.app-slug }}[bot]'
        git config --global user.email '${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com>'
        git tag -a ${{ github.ref_name }} -m "Release ${{ github.ref_name }}"
        git push origin ${{ github.ref_name }}
    - name: Upload json schemas
      run: |
        mv *.json json-schemas/
        git add *.json
        git commit -m "chore: update json schemas"
        git push origin HEAD
    - name: Public github release
      uses: softprops/action-gh-release@v2
      with:
        draft: true
        tag_name: ${{ github.ref_name }}
        repository: onyx-hq/onyx-public-releases
        files: |
          onyx-*
          json-schemas/*
      env:
        GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
