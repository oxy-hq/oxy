name: Public Nightly & Edge Build

on:
  schedule:
    - cron: "0 8 * * *" # Runs every day at midnight Bay Area time (UTC-8)
  push:
    branches:
      - main
    paths-ignore:
      - "docs/**"
  workflow_dispatch:

# Cancel in-progress edge builds when new commits are pushed to main
# Nightly (scheduled) builds run independently and are not cancelled
concurrency:
  group: ${{ github.event_name == 'schedule' && format('nightly-{0}', github.run_id) || 'edge-main' }}
  cancel-in-progress: ${{ github.event_name != 'schedule' }}

env:
  CARGO_TERM_COLOR: always
  MACOSX_DEPLOYMENT_TARGET: "12.0"

defaults:
  run:
    shell: bash

permissions:
  contents: write
  actions: read
  packages: write
  pull-requests: read

jobs:
  changesets:
    name: Changesets
    # Run changesets to detect impacted areas on push/dispatch; nightly schedule proceeds regardless
    uses: ./.github/workflows/changesets.yaml

  build-channel:
    # Only build in public repo; supports nightly (cron) and edge (main pushes)
    needs: [changesets]
    if: github.repository == 'oxy-hq/oxy' && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || needs.changesets.outputs.oxy == 'true' || needs.changesets.outputs.web-app == 'true')
    name: Build ${{ github.event_name == 'schedule' && 'Nightly' || 'Edge' }} CLI for ${{ matrix.job.target }}
    runs-on: ${{ matrix.job.os }}
    strategy:
      fail-fast: false
      matrix:
        job:
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: macos-15-intel
            target: x86_64-apple-darwin
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-22.04-arm
            target: aarch64-unknown-linux-gnu
    steps:
      - uses: actions/create-github-app-token@v2
        name: Create GitHub App Token
        id: app-token
        with:
          app-id: ${{ vars.ARGO_APP_ID }}
          private-key: ${{ secrets.ARGO_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            oxy
            oxy-internal
            oxy-nightly

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Create artifacts folder
        run: mkdir -p artifacts

      - uses: rui314/setup-mold@v1
        if: runner.os == 'Linux'
        with:
          make-default: true

      - name: Prep Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.job.target }}
      - name: Prep cargo cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: build-cli-${{ matrix.job.os }}-${{ matrix.job.target }}
          save-if: ${{ github.ref == 'refs/heads/main' }}

      # protobuf is required by lance https://github.com/lancedb/lance/issues/3073
      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ steps.app-token.outputs.token }}

      #-- Prep node
      - uses: pnpm/action-setup@v4
        with:
          run_install: false
      - name: Install Node.js
        uses: actions/setup-node@v6
        id: setup-node
        with:
          node-version: 24.x
          cache: "pnpm"
      - name: Install dependencies & Build web-app
        env:
          NODE_OPTIONS: "--max_old_space_size=4096"
        run: |
          pnpm install --prefer-frozen-lockfile
          pnpm -C web-app build

      - name: Build oxy cli
        shell: bash
        run: |
          cargo build --profile release --target ${{ matrix.job.target }}
          mv target/${{ matrix.job.target }}/release/oxy artifacts/oxy-${{ matrix.job.target }}

      - name: Generate config schema (once)
        if: ${{ matrix.job.target == 'aarch64-apple-darwin' }}
        run: |
          cargo run --profile release --target ${{ matrix.job.target }} -- gen-config-schema
          cp -a json-schemas/. artifacts/
          cp Cargo.lock artifacts/

      - name: Get current date
        id: date
        run: echo "current_date=$(date -u +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: cli-${{ matrix.job.target }}
          path: artifacts/**/*
          if-no-files-found: error
          retention-days: 1

  publish-channel-release:
    name: Publish ${{ github.event_name == 'schedule' && 'Nightly' || 'Edge' }} Release
    runs-on: ubuntu-latest
    needs: [build-channel]
    steps:
      - uses: actions/create-github-app-token@v2
        name: Create GitHub App Token
        id: app-token
        with:
          app-id: ${{ vars.ARGO_APP_ID }}
          private-key: ${{ secrets.ARGO_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            oxy
            oxy-internal
            oxy-nightly

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Download release assets from artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts
          merge-multiple: true

      - name: List all artifacts
        run: ls -R ./artifacts

      - name: Get current date
        id: date
        run: echo "current_date=$(date -u +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Determine channel and tags
        id: channel
        run: |
          SHORT_SHA=${GITHUB_SHA::7}
          EVENT="$GITHUB_EVENT_NAME"
          DATE="${{ steps.date.outputs.current_date }}"
          if [ "$EVENT" = "schedule" ]; then
            CHANNEL="nightly"
            PRIMARY_TAG="nightly-${DATE}-${SHORT_SHA}"
            DISPLAY_NAME="Nightly Build ${DATE}"
          else
            CHANNEL="edge"
            PRIMARY_TAG="edge-${SHORT_SHA}"
            DISPLAY_NAME="Edge Build ${SHORT_SHA}"
          fi

          # Transitional compatibility tag (to be deprecated later) only for push edge builds
          if [ "$CHANNEL" = "edge" ]; then
            COMPAT_TAG="edge-main-${SHORT_SHA}"
          else
            COMPAT_TAG=""
          fi

          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "channel=${CHANNEL}" >> $GITHUB_OUTPUT
          echo "primary_tag=${PRIMARY_TAG}" >> $GITHUB_OUTPUT
          echo "compat_tag=${COMPAT_TAG}" >> $GITHUB_OUTPUT
          echo "display_name=${DISPLAY_NAME}" >> $GITHUB_OUTPUT

      - name: Create transitional compatibility tag (edge only)
        if: ${{ steps.channel.outputs.compat_tag != '' }}
        run: |
          git tag ${{ steps.channel.outputs.compat_tag }} || true
          git push origin ${{ steps.channel.outputs.compat_tag }} || true

      - name: Publish channel release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ steps.app-token.outputs.token }}
          draft: false
          repository: oxy-hq/oxy-nightly
          prerelease: false
          make_latest: true
          tag_name: ${{ steps.channel.outputs.primary_tag }}
          name: ${{ steps.channel.outputs.display_name }} (${{ steps.channel.outputs.primary_tag }})
          files: |
            artifacts/oxy-*
            artifacts/*.json
          fail_on_unmatched_files: false
          body: |
            Channel: ${{ steps.channel.outputs.channel }}
            Date: ${{ steps.date.outputs.current_date }}
            Commit: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            Primary Tag: ${{ steps.channel.outputs.primary_tag }}
            Transitional Tag: ${{ steps.channel.outputs.compat_tag || 'n/a' }}
            To install:
            `bash <(curl --proto '=https' --tlsv1.2 -LsSf https://nightly.oxy.tech)`

  build-and-publish-docker:
    name: Build ${{ matrix.target.name }} ${{ github.event_name == 'schedule' && 'nightly' || 'edge' }} Docker image for ${{ matrix.arch }}
    needs: [changesets, build-channel]
    if: github.repository == 'oxy-hq/oxy' && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || needs.changesets.outputs.oxy == 'true')
    concurrency:
      group: docker-publish-nightly-${{ matrix.target.name }}-${{ matrix.arch }}
      cancel-in-progress: true
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: true
      matrix:
        arch: [linux/amd64, linux/arm64]
        target:
          - name: runtime
            image: oxy
            target: runtime
          - name: semantic-engine
            image: oxy-semantic-engine
            target: semantic-engine
        include:
          - arch: linux/amd64
            runner: ubuntu-latest
            rust_target: x86_64-unknown-linux-gnu
            arch_tag: amd64
          - arch: linux/arm64
            runner: ubuntu-24.04-arm
            rust_target: aarch64-unknown-linux-gnu
            arch_tag: arm64
    permissions:
      packages: write
      contents: read
      attestations: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download pre-built binary
        uses: actions/download-artifact@v7
        with:
          name: cli-${{ matrix.rust_target }}
          path: artifacts

      - name: Prepare binary for Docker build
        run: |
          cp artifacts/oxy-${{ matrix.rust_target }} oxy
          chmod +x oxy

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine channel and tags
        id: meta
        run: |
          SHORT_SHA=${GITHUB_SHA::7}
          DATE=$(date -u +'%Y%m%d')
          IMAGE="ghcr.io/${{ github.repository_owner }}/${{ matrix.target.image }}"
          ARCH="${{ matrix.arch_tag }}"

          if [ "$GITHUB_EVENT_NAME" = "schedule" ]; then
            TAGS="${IMAGE}:nightly-${DATE}-${ARCH}"
            TAGS="${TAGS},${IMAGE}:nightly-${SHORT_SHA}-${ARCH}"
            TAGS="${TAGS},${IMAGE}:nightly-latest-${ARCH}"
          else
            TAGS="${IMAGE}:edge-${DATE}-${ARCH}"
            TAGS="${TAGS},${IMAGE}:edge-${SHORT_SHA}-${ARCH}"
            TAGS="${TAGS},${IMAGE}:edge-latest-${ARCH}"
            # Transitional compatibility tag
            TAGS="${TAGS},${IMAGE}:edge-main-${SHORT_SHA}-${ARCH}"
          fi

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT

      - name: Build and push ${{ matrix.target.name }} image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.prebuilt
          target: ${{ matrix.target.target }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          build-args: BINARY_PATH=oxy
          provenance: false
          cache-from: type=gha,scope=${{ matrix.target.name }}-${{ matrix.arch_tag }}
          cache-to: type=gha,mode=min,scope=${{ matrix.target.name }}-${{ matrix.arch_tag }}

  create-and-push-manifest:
    name: Create ${{ matrix.target.name }} ${{ github.event_name == 'schedule' && 'nightly' || 'edge' }} manifest
    if: github.repository == 'oxy-hq/oxy'
    needs: build-and-publish-docker
    runs-on: ubuntu-24.04-arm
    strategy:
      matrix:
        target:
          - name: runtime
            image: oxy
          - name: semantic-engine
            image: oxy-semantic-engine
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current date
        id: date
        run: echo "current_date=$(date -u +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Determine channel
        id: channel
        run: |
          SHORT_SHA=${GITHUB_SHA::7}
          DATE="${{ steps.date.outputs.current_date }}"
          if [ "$GITHUB_EVENT_NAME" = "schedule" ]; then
            CHANNEL="nightly"
            DATE_TAG="nightly-${DATE}"
            LATEST_TAG="nightly-latest"
            COMPAT_TAG=""
          else
            CHANNEL="edge"
            DATE_TAG="edge-${DATE}"
            LATEST_TAG="edge-latest"
            # Transitional compatibility tag
            COMPAT_TAG="edge-main-${SHORT_SHA}"
          fi
          echo "channel=${CHANNEL}" >> $GITHUB_OUTPUT
          echo "date_tag=${DATE_TAG}" >> $GITHUB_OUTPUT
          echo "latest_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "compat_tag=${COMPAT_TAG}" >> $GITHUB_OUTPUT

      - name: Create and push multi-arch manifests for ${{ matrix.target.name }}
        run: |
          IMAGE_NAME="${{ matrix.target.image }}"
          DATE_TAG="${{ steps.channel.outputs.date_tag }}"
          LATEST_TAG="${{ steps.channel.outputs.latest_tag }}"
          COMPAT_TAG="${{ steps.channel.outputs.compat_tag }}"
          CHANNEL="${{ steps.channel.outputs.channel }}"

          echo "Creating $CHANNEL manifests for $IMAGE_NAME..."

          docker manifest create ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${DATE_TAG} \
            ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${DATE_TAG}-amd64 \
            ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${DATE_TAG}-arm64
          docker manifest push ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${DATE_TAG}

          docker manifest create ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${LATEST_TAG} \
            ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${LATEST_TAG}-amd64 \
            ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${LATEST_TAG}-arm64
          docker manifest push ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${LATEST_TAG}

          # Create transitional compatibility manifest for edge builds
          if [ -n "$COMPAT_TAG" ]; then
            docker manifest create ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${COMPAT_TAG} \
              ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${COMPAT_TAG}-amd64 \
              ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${COMPAT_TAG}-arm64
            docker manifest push ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${COMPAT_TAG}
            echo "✅ Published compatibility manifest: ${COMPAT_TAG}"
          fi

          echo "✅ Published $CHANNEL manifests for $IMAGE_NAME"
