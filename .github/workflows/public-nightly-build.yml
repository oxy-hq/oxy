name: Public Nightly & Edge Build

on:
  schedule:
    - cron: "0 8 * * *" # Runs every day at midnight Bay Area time (UTC-8)
  push:
    branches:
      - main
    paths-ignore:
      - "docs/**"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  MACOSX_DEPLOYMENT_TARGET: "11.0"

defaults:
  run:
    shell: bash

permissions:
  contents: write
  actions: read
  packages: write
  pull-requests: read

jobs:
  changesets:
    name: Changesets
    # Run changesets to detect impacted areas on push/dispatch; nightly schedule proceeds regardless
    uses: ./.github/workflows/changesets.yaml

  build-channel:
    # Only build in public repo; supports nightly (cron) and edge (main pushes)
    needs: [changesets]
    if: github.repository == 'oxy-hq/oxy' && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || needs.changesets.outputs.oxy == 'true' || needs.changesets.outputs.web-app == 'true')
    name: Build ${{ github.event_name == 'schedule' && 'Nightly' || 'Edge' }} CLI for ${{ matrix.job.target }}
    runs-on: ${{ matrix.job.os }}
    strategy:
      fail-fast: false
      matrix:
        job:
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-22.04-arm
            target: aarch64-unknown-linux-gnu
    steps:
      - uses: actions/create-github-app-token@v2
        name: Create GitHub App Token
        id: app-token
        with:
          app-id: ${{ vars.ARGO_APP_ID }}
          private-key: ${{ secrets.ARGO_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            oxy
            oxy-internal
            oxy-nightly

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Create artifacts folder
        run: mkdir -p artifacts

      - uses: rui314/setup-mold@v1
        if: runner.os == 'Linux'
        with:
          make-default: true

      - name: Prep Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.job.target }}
      - name: Prep cargo cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: build-cli-${{ matrix.job.os }}-${{ matrix.job.target }}
          cache-all-crates: "true"
          save-if: ${{ github.ref == 'refs/heads/main' }}

      # protobuf is required by lance https://github.com/lancedb/lance/issues/3073
      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ steps.app-token.outputs.token }}

      #-- Prep node
      - uses: pnpm/action-setup@v4
        with:
          run_install: false
      - name: Install Node.js
        uses: actions/setup-node@v6
        id: setup-node
        with:
          node-version: 24.x
          cache: "pnpm"
      - name: Install dependencies & Build web-app
        env:
          NODE_OPTIONS: "--max_old_space_size=4096"
        run: |
          pnpm install --prefer-frozen-lockfile
          pnpm -C web-app build

      - name: Build oxy cli
        shell: bash
        run: |
          cargo build --release --target ${{ matrix.job.target }}
          mv target/${{ matrix.job.target }}/release/oxy artifacts/oxy-${{ matrix.job.target }}

      - name: Generate config schema (once)
        if: ${{ matrix.job.target == 'aarch64-apple-darwin' }}
        run: |
          cargo run --release --target ${{ matrix.job.target }} -- gen-config-schema
          cp -a json-schemas/. artifacts/
          cp Cargo.lock artifacts/

      - name: Get current date
        id: date
        run: echo "current_date=$(date -u +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: cli-${{ matrix.job.target }}
          path: artifacts/**/*
          if-no-files-found: error
          retention-days: 1

  publish-channel-release:
    name: Publish ${{ github.event_name == 'schedule' && 'Nightly' || 'Edge' }} Release
    runs-on: ubuntu-latest
    needs: [build-channel]
    steps:
      - uses: actions/create-github-app-token@v2
        name: Create GitHub App Token
        id: app-token
        with:
          app-id: ${{ vars.ARGO_APP_ID }}
          private-key: ${{ secrets.ARGO_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            oxy
            oxy-internal
            oxy-nightly

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Download release assets from artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts
          merge-multiple: true

      - name: List all artifacts
        run: ls -R ./artifacts

      - name: Get current date
        id: date
        run: echo "current_date=$(date -u +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Determine channel and tags
        id: channel
        run: |
          SHORT_SHA=${GITHUB_SHA::7}
          EVENT="$GITHUB_EVENT_NAME"
          DATE="${{ steps.date.outputs.current_date }}"
          if [ "$EVENT" = "schedule" ]; then
            CHANNEL="nightly"
            PRIMARY_TAG="nightly-${DATE}-${SHORT_SHA}"
            DISPLAY_NAME="Nightly Build ${DATE}"
          else
            CHANNEL="edge"
            PRIMARY_TAG="edge-${SHORT_SHA}"
            DISPLAY_NAME="Edge Build ${SHORT_SHA}"
          fi

          # Transitional compatibility tag (to be deprecated later) only for push edge builds
          if [ "$CHANNEL" = "edge" ]; then
            COMPAT_TAG="nightly-main-${SHORT_SHA}"
          else
            COMPAT_TAG=""
          fi

          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "channel=${CHANNEL}" >> $GITHUB_OUTPUT
          echo "primary_tag=${PRIMARY_TAG}" >> $GITHUB_OUTPUT
          echo "compat_tag=${COMPAT_TAG}" >> $GITHUB_OUTPUT
          echo "display_name=${DISPLAY_NAME}" >> $GITHUB_OUTPUT

      - name: Create transitional compatibility tag (edge only)
        if: ${{ steps.channel.outputs.compat_tag != '' }}
        run: |
          git tag ${{ steps.channel.outputs.compat_tag }} || true
          git push origin ${{ steps.channel.outputs.compat_tag }} || true

      - name: Publish channel release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ steps.app-token.outputs.token }}
          draft: false
          repository: oxy-hq/oxy-nightly
          prerelease: false
          make_latest: true
          tag_name: ${{ steps.channel.outputs.primary_tag }}
          name: ${{ steps.channel.outputs.display_name }} (${{ steps.channel.outputs.primary_tag }})
          files: |
            artifacts/oxy-*
            artifacts/*.json
          fail_on_unmatched_files: false
          body: |
            Channel: ${{ steps.channel.outputs.channel }}
            Date: ${{ steps.date.outputs.current_date }}
            Commit: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            Primary Tag: ${{ steps.channel.outputs.primary_tag }}
            Transitional Tag: ${{ steps.channel.outputs.compat_tag || 'n/a' }}
            To install:
            `bash <(curl --proto '=https' --tlsv1.2 -LsSf https://nightly.oxy.tech)`

  build-and-publish-docker:
    name: Build ${{ matrix.target.name }} ${{ github.event_name == 'schedule' && 'nightly' || 'edge' }} Docker image for ${{ matrix.arch }}
    needs: [changesets, publish-channel-release]
    if: github.repository == 'oxy-hq/oxy' && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || needs.changesets.outputs.oxy == 'true')
    concurrency:
      group: docker-publish-nightly-${{ matrix.target.name }}-${{ matrix.arch }}
      cancel-in-progress: true
    runs-on: ${{ matrix.arch == 'linux/amd64' && 'ubuntu-latest' || 'ubuntu-24.04-arm' }}
    strategy:
      fail-fast: true
      matrix:
        arch: [linux/amd64, linux/arm64]
        target:
          - name: runtime
            image: oxy
            dockerfile: Dockerfile
            target: runtime
          - name: semantic-engine
            image: oxy-semantic-engine
            dockerfile: Dockerfile
            target: semantic-engine
    permissions:
      packages: write
      contents: read
      attestations: write
      id-token: write
    steps:
      - uses: actions/create-github-app-token@v2
        name: Create GitHub App Token
        id: app-token
        with:
          app-id: ${{ vars.ARGO_APP_ID }}
          private-key: ${{ secrets.ARGO_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            oxy
            oxy-internal
            oxy-nightly

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current date
        id: date
        run: echo "current_date=$(date -u +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Determine channel and tags
        id: channel
        run: |
          SHORT_SHA=${GITHUB_SHA::7}
          DATE="${{ steps.date.outputs.current_date }}"
          if [ "$GITHUB_EVENT_NAME" = "schedule" ]; then
            CHANNEL="nightly"
            DATE_TAG="nightly-${DATE}"
            SHA_TAG="nightly-${SHORT_SHA}"
            LATEST_TAG="nightly-latest"
          else
            CHANNEL="edge"
            DATE_TAG="edge-${DATE}"
            SHA_TAG="edge-${SHORT_SHA}"
            LATEST_TAG="edge-latest"
            # Transitional compatibility SHA tag
            COMPAT_SHA_TAG="nightly-main-${SHORT_SHA}"
          fi
          echo "channel=${CHANNEL}" >> $GITHUB_OUTPUT
          echo "date_tag=${DATE_TAG}" >> $GITHUB_OUTPUT
          echo "sha_tag=${SHA_TAG}" >> $GITHUB_OUTPUT
          echo "latest_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "compat_sha_tag=${COMPAT_SHA_TAG}" >> $GITHUB_OUTPUT

      - name: Build and push ${{ matrix.target.name }} ${{ matrix.arch }} image
        run: |
          ARCH_TAG=$(echo "${{ matrix.arch }}" | awk -F'/' '{print $2}')
          TARGET_NAME="${{ matrix.target.name }}"
          IMAGE_NAME="${{ matrix.target.image }}"
          DOCKERFILE="${{ matrix.target.dockerfile }}"
          TARGET_STAGE="${{ matrix.target.target }}"
          CHANNEL="${{ steps.channel.outputs.channel }}"
          DATE_TAG="${{ steps.channel.outputs.date_tag }}"
          SHA_TAG="${{ steps.channel.outputs.sha_tag }}"
          LATEST_TAG="${{ steps.channel.outputs.latest_tag }}"
          COMPAT_SHA_TAG="${{ steps.channel.outputs.compat_sha_tag }}"

          echo "Building $TARGET_NAME $CHANNEL for ${{ matrix.arch }}..."

          docker build -f $DOCKERFILE \
            --target $TARGET_STAGE \
            --platform ${{ matrix.arch }} \
            -t ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${DATE_TAG}-${ARCH_TAG} .
          docker push ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${DATE_TAG}-${ARCH_TAG}

          docker build -f $DOCKERFILE \
            --target $TARGET_STAGE \
            --platform ${{ matrix.arch }} \
            -t ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${SHA_TAG}-${ARCH_TAG} .
          docker push ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${SHA_TAG}-${ARCH_TAG}

          docker build -f $DOCKERFILE \
            --target $TARGET_STAGE \
            --platform ${{ matrix.arch }} \
            -t ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${LATEST_TAG}-${ARCH_TAG} .
          docker push ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${LATEST_TAG}-${ARCH_TAG}

          if [ -n "$COMPAT_SHA_TAG" ]; then
            docker build -f $DOCKERFILE \
              --target $TARGET_STAGE \
              --platform ${{ matrix.arch }} \
              -t ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${COMPAT_SHA_TAG}-${ARCH_TAG} .
            docker push ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${COMPAT_SHA_TAG}-${ARCH_TAG}
          fi

  create-and-push-manifest:
    name: Create ${{ matrix.target.name }} ${{ github.event_name == 'schedule' && 'nightly' || 'edge' }} manifest
    if: github.repository == 'oxy-hq/oxy'
    needs: build-and-publish-docker
    runs-on: ubuntu-24.04-arm
    strategy:
      matrix:
        target:
          - name: runtime
            image: oxy
          - name: semantic-engine
            image: oxy-semantic-engine
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current date
        id: date
        run: echo "current_date=$(date -u +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Determine channel
        id: channel
        run: |
          DATE="${{ steps.date.outputs.current_date }}"
          if [ "$GITHUB_EVENT_NAME" = "schedule" ]; then
            CHANNEL="nightly"
            DATE_TAG="nightly-${DATE}"
            LATEST_TAG="nightly-latest"
          else
            CHANNEL="edge"
            DATE_TAG="edge-${DATE}"
            LATEST_TAG="edge-latest"
          fi
          echo "channel=${CHANNEL}" >> $GITHUB_OUTPUT
          echo "date_tag=${DATE_TAG}" >> $GITHUB_OUTPUT
          echo "latest_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT

      - name: Create and push multi-arch manifests for ${{ matrix.target.name }}
        run: |
          IMAGE_NAME="${{ matrix.target.image }}"
          DATE_TAG="${{ steps.channel.outputs.date_tag }}"
          LATEST_TAG="${{ steps.channel.outputs.latest_tag }}"
          CHANNEL="${{ steps.channel.outputs.channel }}"

          echo "Creating $CHANNEL manifests for $IMAGE_NAME..."

          docker manifest create ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${DATE_TAG} \
            ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${DATE_TAG}-amd64 \
            ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${DATE_TAG}-arm64
          docker manifest push ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${DATE_TAG}

          docker manifest create ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${LATEST_TAG} \
            ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${LATEST_TAG}-amd64 \
            ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${LATEST_TAG}-arm64
          docker manifest push ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:${LATEST_TAG}

          echo "âœ… Published $CHANNEL manifests for $IMAGE_NAME"

  cleanup-old-nightly:
    name: Cleanup nightly releases and Docker tags older than 30 days
    if: github.repository == 'oxy-hq/oxy'
    needs: [create-and-push-manifest]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Calculate cutoff date
        id: cutoff
        run: |
          # Cutoff is 30 days ago in UTC YYYYMMDD
          CUTOFF=$(date -u -d '30 days ago' +'%Y%m%d')
          echo "cutoff=${CUTOFF}" >> $GITHUB_OUTPUT
          echo "Cutoff date (YYYYMMDD): ${CUTOFF}"

      - name: Delete nightly releases in oxy-nightly older than cutoff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CUTOFF="${{ steps.cutoff.outputs.cutoff }}"
          echo "Fetching releases from oxy-hq/oxy-nightly..."
          gh api repos/oxy-hq/oxy-nightly/releases --paginate \
            | jq -r '.[] | "\(.tag_name) \(.id) \(.created_at)"' \
            | while read -r TAG ID CREATED; do
                if [[ "$TAG" == nightly-* ]]; then
                  # Try to extract YYYYMMDD from tag (nightly-YYYYMMDD-*)
                  DATE_PART=$(echo "$TAG" | sed -E 's/^nightly-([0-9]{8}).*/\1/')
                  if [[ $DATE_PART =~ ^[0-9]{8}$ ]]; then
                    if [[ "$DATE_PART" < "$CUTOFF" ]]; then
                      echo "Deleting release $TAG (id=$ID, created=$CREATED)"
                      gh api -X DELETE repos/oxy-hq/oxy-nightly/releases/$ID || true
                    fi
                  else
                    echo "Skipping non-date nightly tag: $TAG"
                  fi
                fi
              done

      - name: Delete old nightly Docker tags (oxy, oxy-semantic-engine)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CUTOFF="${{ steps.cutoff.outputs.cutoff }}"
          OWNER="${{ github.repository_owner }}"
          for PKG in oxy oxy-semantic-engine; do
            echo "Fetching container versions for ghcr.io/$OWNER/$PKG..."
            # List all container versions (paginate up to 100 per page)
            PAGE=1
            while true; do
              RESP=$(gh api \
                -H "Accept: application/vnd.github+json" \
                /orgs/$OWNER/packages/container/$PKG/versions --paginate || true)
              if [ -z "$RESP" ]; then
                break
              fi
              echo "$RESP" | jq -c '.[]' | while read -r VER; do
                ID=$(echo "$VER" | jq -r '.id')
                CREATED=$(echo "$VER" | jq -r '.created_at')
                CREATED_DATE=$(date -u -d "$CREATED" +'%Y%m%d' 2>/dev/null || echo "00000000")
                TAGS=$(echo "$VER" | jq -r '.metadata.container.tags[]?' | tr '\n' ' ')
                if echo "$TAGS" | grep -qE '\bnightly-'; then
                  if [[ "$CREATED_DATE" < "$CUTOFF" ]]; then
                    echo "Deleting nightly version id=$ID (created=$CREATED, tags=$TAGS)"
                    gh api -X DELETE /orgs/$OWNER/packages/container/$PKG/versions/$ID || true
                  else
                    echo "Keeping nightly version id=$ID (created=$CREATED)"
                  fi
                fi
              done
              break
            done
          done
