name: Public Announce Release to Slack

on:
  workflow_run:
    workflows: ["Public Release", "Publish Docker Images"]
    types:
      - completed

jobs:
  announce-to-slack:
    if: github.repository == 'oxy-hq/oxy' && github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Send Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_USERNAME: "Release Notifier"
          MSG_MINIMAL: ref,commit
          SLACK_ICON_EMOJI: ":rocket:"
          SLACK_LINK_NAMES: true
          SLACKIFY_MARKDOWN: true
          SLACK_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: general
          SLACK_FOOTER: ""
          SLACK_TITLE: |
            :tada: ${{ github.event.workflow_run.name }} Completed :tada:
          SLACK_MESSAGE: |
            *Details:*
            - *Workflow:* ${{ github.event.workflow_run.name }}
            - *Branch/Tag:* ${{ github.event.workflow_run.head_branch }}
            - *Completed At:* ${{ github.event.workflow_run.updated_at }}

            ${{ github.event.workflow_run.name == 'Public Release' && 'To install: `bash <(curl --proto ''=https'' --tlsv1.2 -LsSf https://get.oxy.tech)`' || 'Docker images published. See the workflow run for pull commands.' }}

            View the workflow run: ${{ github.event.workflow_run.html_url }}
