name: Public Announce Release to Slack

on:
  workflow_run:
    workflows: ["Public Release"]
    types:
      - completed

jobs:
  announce-to-slack:
    # Only announce stable releases (tag pushes), not nightly/edge builds
    if: |
      github.repository == 'oxy-hq/oxy' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch != 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_USERNAME: "Release Notifier"
          MSG_MINIMAL: ref,commit
          SLACK_ICON_EMOJI: ":rocket:"
          SLACK_LINK_NAMES: true
          SLACKIFY_MARKDOWN: true
          SLACK_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: general
          SLACK_FOOTER: ""
          SLACK_TITLE: |
            :tada: Stable Release ${{ github.event.workflow_run.head_branch }} :tada:
          SLACK_MESSAGE: |
            *Details:*
            - *Version:* ${{ github.event.workflow_run.head_branch }}
            - *Completed At:* ${{ github.event.workflow_run.updated_at }}

            To install: `bash <(curl --proto '=https' --tlsv1.2 -LsSf https://get.oxy.tech)`
            To install this version: `OXY_VERSION=${{ github.event.workflow_run.head_branch }} bash <(curl --proto '=https' --tlsv1.2 -LsSf https://get.oxy.tech)`

            Docker images: `ghcr.io/oxy-hq/oxy:${{ github.event.workflow_run.head_branch }}`

            View the workflow run: ${{ github.event.workflow_run.html_url }}
