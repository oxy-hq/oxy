name: Prepare Release
on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - "docs/**"
env:
  CARGO_TERM_COLOR: always
  MACOSX_DEPLOYMENT_TARGET: "11.0"

jobs:
  changesets:
    uses: ./.github/workflows/changesets.yaml
  # release-new:
  #   name: Release new tag version
  #   needs: [changesets]
  #   if: needs.changesets.outputs.onyx == 'true' || github.event_name == 'workflow_dispatch'
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/create-github-app-token@v1
  #       name: Create GitHub App Token
  #       id: app-token
  #       with:
  #         app-id: ${{ vars.ARGO_APP_ID }}
  #         private-key: ${{ secrets.ARGO_APP_PRIVATE_KEY }}
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #         token: ${{ steps.app-token.outputs.token }}
  #     - name: Prep Rust
  #       uses: dtolnay/rust-toolchain@stable
  #       with:
  #         components: clippy, rustfmt
  #     - name: Prep cargo cache
  #       uses: Swatinem/rust-cache@v2
  #       with:
  #         shared-key: release-ubuntu-latest-x86_64-unknown-linux-gnu
  #     - name: Run release-plz
  #       uses: release-plz/action@v0.5
  #       with:
  #         command: release
  #       env:
  #         GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
  release-new:
    needs: [changesets]
    if: needs.changesets.outputs.onyx == 'true' || github.event_name == 'workflow_dispatch'
    concurrency:
      group: prepare-release-${{ github.ref_name }}
      cancel-in-progress: false
    name: Release-please
    runs-on: ubuntu-latest
    steps:
      - uses: actions/create-github-app-token@v1
        name: Create GitHub App Token
        id: app-token
        with:
          app-id: ${{ vars.ARGO_APP_ID }}
          private-key: ${{ secrets.ARGO_APP_PRIVATE_KEY }}
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}
      # use release-please until https://github.com/release-plz/release-plz/issues/1144 is closed
      - name: Run release-please to trigger PR
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
  update-json-schemas:
    name: Update JSON Schemas
    needs: [changesets]
    if: needs.changesets.outputs.onyx == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    concurrency:
      group: json-schema-${{ github.ref_name }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4
      - name: Prep Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
      - name: Prep cargo cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: release-ubuntu-latest-x86_64-unknown-linux-gnu
      # protobuf is required by lance https://github.com/lancedb/lance/issues/3073
      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Update json schemas
        shell: bash
        run: |
          cargo run -- gen-config-schema --check
      - name: Commit json schemas changes
        uses: EndBug/add-and-commit@v9 # You can change this to use a specific version.
        with:
          add: "json-schemas"
          message: "Update JSON Schemas"
